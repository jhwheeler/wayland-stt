#!/usr/bin/env bash
#
# voice-to-text — push-to-talk toggle for Wayland
# 1st press: start recording   2nd press: stop, transcribe, type into terminal
#
# Flags:
#   --copy   Copy last transcription to clipboard (retrieve after the fact)
#

set -euo pipefail

DATA_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/wayland-stt"
VENV_PYTHON="$DATA_DIR/venv/bin/python"
TRANSCRIBE="$DATA_DIR/transcribe.py"

# Use XDG_RUNTIME_DIR for temp files (user-private, typically /run/user/UID)
# Falls back to a user-specific directory in /tmp for security
RUNTIME_DIR="${XDG_RUNTIME_DIR:-/tmp/wayland-stt-$UID}"
mkdir -p "$RUNTIME_DIR"
chmod 700 "$RUNTIME_DIR" 2>/dev/null || true

PID_FILE="$RUNTIME_DIR/voice-to-text.pid"
WAV_FILE="$RUNTIME_DIR/voice-to-text.wav"
LOG_FILE="$RUNTIME_DIR/voice-to-text.log"
TEXT_FILE="$RUNTIME_DIR/voice-to-text.txt"
HINT="string:x-canonical-private-synchronous:voice-to-text"

notify() {
    local timeout="${1:--1}"; shift
    notify-send -a "Voice Recorder" -t "$timeout" -h "$HINT" "$@"
}

# ── Copy last transcription to clipboard ─────────────────────────────
if [[ "${1:-}" == "--copy" ]]; then
    if [[ -s "$TEXT_FILE" ]]; then
        wl-copy < "$TEXT_FILE"
        notify 3000 "Copied" "$(cat "$TEXT_FILE")"
    else
        notify 3000 "Nothing to copy" "No previous transcription found."
    fi
    exit 0
fi

# ── Stop recording & transcribe ──────────────────────────────────────
if [[ -f "$PID_FILE" ]]; then
    pid=$(cat "$PID_FILE")
    rm -f "$PID_FILE"

    # Validate PID is numeric to prevent injection
    if [[ ! "$pid" =~ ^[0-9]+$ ]]; then
        notify 5000 "Error" "Invalid PID file contents."
        exit 1
    fi

    if kill -0 "$pid" 2>/dev/null; then
        kill -INT "$pid"
        # Poll until ffmpeg exits (can't use wait — different shell)
        for _ in $(seq 1 50); do
            kill -0 "$pid" 2>/dev/null || break
            sleep 0.1
        done
    fi

    if [[ ! -s "$WAV_FILE" ]]; then
        notify 5000 "Error" "Recording is empty — nothing to transcribe."
        exit 1
    fi

    notify -1 "Transcribing..."

    text=$("$VENV_PYTHON" "$TRANSCRIBE" "$WAV_FILE" 2>"$LOG_FILE") || true

    if [[ -z "$text" ]]; then
        err=$(cat "$LOG_FILE" 2>/dev/null || echo "unknown error")
        notify 5000 "Error" "Transcription failed: $err"
        exit 1
    fi

    # Save for later retrieval, then type into focused window
    printf '%s' "$text" > "$TEXT_FILE"
    wtype -- "$text"

    notify 5000 "Transcribed" "$text"
    exit 0
fi

# ── Start recording ──────────────────────────────────────────────────

if ! pactl info &>/dev/null; then
    notify 5000 "Error" "PulseAudio/PipeWire not available."
    exit 1
fi

rm -f "$WAV_FILE"

ffmpeg -y -f pulse -i default -ac 1 -ar 16000 "$WAV_FILE" &>/dev/null &
echo $! > "$PID_FILE"

notify 0 "Recording..." "Press ALT+R again to stop."
